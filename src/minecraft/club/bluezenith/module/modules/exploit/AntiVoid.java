package club.bluezenith.module.modules.exploit;

import club.bluezenith.events.Listener;
import club.bluezenith.events.impl.MoveEvent;
import club.bluezenith.module.Module;
import club.bluezenith.module.ModuleCategory;
import club.bluezenith.module.modules.movement.LongJump2;
import club.bluezenith.module.value.types.FloatValue;
import net.minecraft.block.BlockAir;
import net.minecraft.util.BlockPos;

public class AntiVoid extends Module {
    private final FloatValue fallDistance = new FloatValue("Fall distance", 3, 0.1f, 10f, 0.1f, true, null).setIndex(1);

    private double lastGroundX = 0;
    private double lastGroundY = 0;
    private double lastGroundZ = 0;
    private boolean flag = false;

    public AntiVoid() {
        super("AntiVoid", ModuleCategory.EXPLOIT);
    }

    @Listener
    public void onMove(MoveEvent e) {
        if (e.isPost()) return;
        if(mc.thePlayer.onGround) {
            lastGroundX = mc.thePlayer.posX;
            lastGroundY = mc.thePlayer.posY;
            lastGroundZ = mc.thePlayer.posZ;
            flag = false;
            return;
        }

        if(!flag && mc.thePlayer.fallDistance > fallDistance.get() && isVoidBelow() && !getCastedModule(LongJump2.class).getState()) {
            //PacketUtil.sendSilent(new C03PacketPlayer.C04PacketPlayerPosition(mc.thePlayer.posX, lastGroundY + 1, mc.thePlayer.posZ, false));
            e.y = 0;
        //    PacketUtil.sendSilent(new C08PacketPlayerBlockPlacement(mc.thePlayer.getHeldItem()));
          //  player.setPosition(lastGroundX, lastGroundY + 0.5, lastGroundZ);
       //     flag = true;
        }
    }

//    @Listener
//    public void onUpdate(UpdatePlayerEvent e) {
//
//    }

    private boolean isVoidBelow() {
        if(mc.thePlayer.onGround) return false;
        for(double i = mc.thePlayer.posY; i > 0; i--) {
            BlockPos pos = new BlockPos(mc.thePlayer.posX, i, mc.thePlayer.posZ);
            if(!(mc.theWorld.getBlockState(pos).getBlock() instanceof BlockAir))
                return false;
            pos = null;
        }
        return true;
    }
}
