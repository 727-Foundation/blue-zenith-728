package club.bluezenith.module.modules.exploit.disabler;

import club.bluezenith.BlueZenith;
import club.bluezenith.events.Listener;
import club.bluezenith.events.impl.PacketEvent;
import club.bluezenith.module.value.types.ExtendedModeValue;
import club.bluezenith.util.MinecraftInstance;
import club.bluezenith.util.client.Chat;
import club.bluezenith.util.client.ClientUtils;
import club.bluezenith.util.client.MillisTimer;
import club.bluezenith.util.player.PacketUtil;
import net.minecraft.network.EnumConnectionState;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.server.S02PacketChat;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;

import static java.lang.String.format;

public class PulsiveHVH extends MinecraftInstance implements ExtendedModeValue.Mode {

    private int expectedLagbacks = 0;

    private final MillisTimer timer = new MillisTimer();
    private int kps;

    @Listener
    public void onPacket(PacketEvent event) {
        if(event.packet instanceof C03PacketPlayer && timer.hasTimeReached(50L)) {
            Chat.bz(" the " + EnumConnectionState.PLAY.getPacketId(event.direction, event.packet));
            timer.reset();
        }
        if(event.packet instanceof S02PacketChat) {
            final String content = ((S02PacketChat) event.packet).getChatComponent().getUnformattedText();

            if(content.contains("DEATH!")) { //todo replace with pos set to spawn for death detection (s08)
                expectedLagbacks = 0;

                BlueZenith.getBlueZenith().getNotificationPublisher().postInfo(
                        "Disabler",
                        "You might not be able to fly for a few seconds",
                        2500
                );
                flag(8);
            } else if(content.contains("KILL!")) { //this is really just used for botting, shouldn't be done here but i dont really care
                final String[] split = content.split(" ");

                if(split.length < 6) return;
                ClientUtils.debug("Bots",
                        format("Killed %s, %s xp, +%s gold",
                                split[3],
                                split[4].replace("XP", ""),
                                split[5].replace("g", ""))
                );
                event.cancel();
            }
        }

        if(event.packet instanceof S08PacketPlayerPosLook && mc.getNetHandler().doneLoadingTerrain) {
            if(expectedLagbacks > 0) { //this disabler works by cancelling set position packets sent by the anticheat. i have no idea why it works lmao
                event.cancel();
                expectedLagbacks--;
            } else {
                expectedLagbacks = 0;
                flag(3);
            }
        }
    }

    private void flag(int packetAmount) { //this makes the player flag the anticheat instantly by teleporting back and forth x times
            for (int i = 0; i < packetAmount; i++) {
                boolean rand = i % 2 == 0;

                PacketUtil.sendSilent(new C03PacketPlayer.C04PacketPlayerPosition(
                        mc.thePlayer.posX -Math.sin(Math.toRadians(mc.thePlayer.rotationYaw)) * (rand ? 4 : -4),
                        mc.thePlayer.posY,
                        mc.thePlayer.posZ + Math.cos(Math.toRadians(mc.thePlayer.rotationYaw)) * (rand ? 4 : -4),
                        true
                ));

                expectedLagbacks++;
            }
    }
}